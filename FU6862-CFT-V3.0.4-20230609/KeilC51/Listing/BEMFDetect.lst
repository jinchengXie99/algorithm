C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE BEMFDETECT
OBJECT MODULE PLACED IN .\Output\BEMFDetect.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\User\Source\Function\BEMFDetect.c LARGE OMF2 WARNINGLEVEL(0) OPTIMIZE
                    -(9,SPEED) BROWSE INCDIR(..\User\Include;..\FU68xx_Hardware_Driver\Include) DEBUG PRINT(.\Listing\BEMFDetect.lst) TABS(2)
                    - OBJECT(.\Output\BEMFDetect.obj)

line level    source

   1          /*  -------------------------- (C) COPYRIGHT 2022 Fortiortech ShenZhen ---------------------------*/
   2          /**
   3           * @copyright (C) COPYRIGHT 2022 Fortiortech Shenzhen
   4           * @file      xxx.c
   5           * @author    Fortiortech  Appliction Team
   6           * @since     Create:2022-07-14
   7           * @date      Last modify:2022-07-14
   8           * @note      Last modify author is Leo.li
   9           * @brief      
  10           */
  11          
  12          
  13          /* Includes -------------------------------------------------------------------------------------*/
  14          #include <FU68xx_2.h>
  15          #include <Myproject.h>
  16          
  17          #if ((FRDetectMethod == BEMFMethod) && (TailWind_Mode == TailWind))
              
              BEMFDetect_TypeDef xdata BEMFDetect;
              
              /** 
               * @brief      BEMFÁöÑÂàùÂßãÂåñÔºåÂåÖÊã¨ÂèòÈáèÂàùÂßãÂåñÔºå‰ΩøËÉΩÊØîËæÉÂô®
               * @date       2022-07-14
               */ 
              void BEMFDetectInit(void)
              {
                  //BEMFÊ£ÄÊµãÂâçÂÖ≥Èó≠mosËæìÂá∫
                  BEMFDetect.BEMFSpeed = 0;
                  BEMFDetect.BEMFSpeedBase = 0;
                  BEMFDetect.BEMFStatus = 0;
                  BEMFDetect.FRStatus      = MCCtrl.FR_Status;
                  BEMFDetect.BEMFTimeCount = BEMF_START_DETECT_TIME;//ÂàùÂßãÂèçÁîµÂä®ÂäøÊ£ÄÊµãÊó∂Èó¥
                  BEMFDetect.BEMFSpeedInitStatus = 0;
                  BEMFDetect.FlagSpeedCal = 0;
                  BEMFDetect.BEMFStartStatus = 0;
                
              
                  //‰ΩøËÉΩÂÆöÊó∂Âô®2Áî®‰∫éÊ£ÄÊµãÊó∂Èó¥
                  Time2_BMEF_Init();
                  //‰ΩøËÉΩÊØîËæÉÂô®
                  CMP_BMEF_Init();
              }
              
              /** 
               * @brief      BMFÂØπÂ∫îTime2ÁöÑÂàùÂßãÂåñ
               * @date       2022-07-14
               */
              void CMP_BMEF_Init(void)
              {
                  /*  -------------------------------------------------------------------------------------------------
                      CMP Input Pin Mode
                      0: GPIO Mode, P1.4--CMP0_IN+, P1.6--CMP1_IN+, P2.1--CMP2_IN+
                                P1.5--CMP0_IN-, P1.7--CMP1_IN-, P2.2--CMP2_IN-
C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 2   

                      1: BEMF Mode, ÊØîËæÉÂô®Ê≠£Á´ØËøûÊé•Âà∞ÂÜÖÈÉ®ÊòüÂûãËøûÊé•ÁîµÈòªU„ÄÅV„ÄÅWÁöÑBMEFÈááÊ†∑ÁÇπÔºå
                                ÊØîËæÉÂô®Ë¥üÁ´ØËøûÊé•Âà∞ÂÜÖÈÉ®ÊòüÂûãËøûÊé•ÁîµÈòªÁöÑËôöÊãü‰∏≠ÊÄßÁÇπ
                                ÊØîËæÉÂô®Ë¥üÁ´Ø‰∏éP1.5/P1.7/P2.2Êñ≠ÂºÄÔºåËøô‰∏â‰∏™GPIOÂèØÂÅöÂÖ∂‰ªñÁî®ÈÄî
                      -------------------------------------------------------------------------------------------------*
             -/
                  SetBit(P1_AN, P14 | P16);                                   // CMP0„ÄÅCMP1
                  SetBit(P2_AN, P21);                                         // CMP2
                  /*  -------------------------------------------------------------------------------------------------
                      CMP0_MODÔºö
                      00Ôºö    Êó†ÂÜÖÁΩÆËôöÊãü‰∏≠ÂøÉÁÇπÁîµÈòªÁöÑBEMFÊ®°Âºè
                      01Ôºö  ÂÜÖÁΩÆËôöÊãü‰∏≠ÂøÉÁÇπÁîµÈòªÁöÑBEMFÊ®°Âºè
                      10Ôºö  3Â∑ÆÂàÜÊØîËæÉÂô®Ê®°Âºè
                      11Ôºö  2ÊØîËæÉÂô®Ê®°Âºè
                      -------------------------------------------------------------------------------------------------*
             -/
                  SetReg(CMP_CR2, CMP0MOD0 | CMP0MOD1, CMP0MOD0);
                  /*  -------------------------------------------------------------------------------------------------
                      ÊØîËæÉÂô®ËæìÂá∫ÈÄâÊã©ÈÖçÁΩÆÔºå‰∏éCMP0_MODÈÖçÂêà‰ΩøÁî®
                      CMP0_SEL[1:0]=00ÔºåÊØîËæÉÂô®0Â∑•‰ΩúÂú®3ÊØîËæÉÂô®ËΩÆËØ¢Ê®°ÂºèÔºåÊ≠£Á´ØÂú®CMP0P„ÄÅCMP1P„ÄÅCMP2P‰πãÈó
             -¥Ëá™Âä®ËΩÆÊµÅÈÄâÊã©Ôºå
                                    Ë¥üÁ´ØÂõ∫ÂÆöÊé•ÂÜÖÁΩÆBEMFÁîµÈòªÁöÑ‰∏≠ÂøÉÁÇπÔºåÂÖ∂ËæìÂá∫ÁªìÊûúÂàÜÂà´ÈÄÅËá≥CMP0_OUT„ÄÅ
             -CMP1_OUT„ÄÅCMP2_OUT
                      CMP0_SEL[1:0]=01ÔºåÊØîËæÉÂô®0ÈÄâÊã©CMP0ÂØπÂ∫îÁöÑÁ´ØÂè£ÁªÑÂêàÔºåÊ≠£Á´ØÊé•CMP0PÔºåË¥üÁ´ØÊé•ÂÜÖÁΩÆBEM
             -FÁîµÈòªÁöÑ‰∏≠ÂøÉÁÇπÔºåËæìÂá∫Êé•CMP0_OUT
                      CMP0_SEL[1:0]=10ÔºåÊØîËæÉÂô®0ÈÄâÊã©CMP1ÂØπÂ∫îÁöÑÁ´ØÂè£ÁªÑÂêàÔºåÊ≠£Á´ØÊé•CMP1PÔºåË¥üÁ´ØÊé•ÂÜÖÁΩÆBEM
             -FÁîµÈòªÁöÑ‰∏≠ÂøÉÁÇπÔºåËæìÂá∫Êé•CMP1_OUT
                      CMP0_SEL[1:0]=11ÔºåÊØîËæÉÂô®0ÈÄâÊã©CMP2ÂØπÂ∫îÁöÑÁ´ØÂè£ÁªÑÂêàÔºåÊ≠£Á´ØÊé•CMP2PÔºåË¥üÁ´ØÊé•ÂÜÖÁΩÆBEM
             -FÁîµÈòªÁöÑ‰∏≠ÂøÉÁÇπÔºåËæìÂá∫Êé•CMP2_OUT
                  
                      -----------------------------------------------------------------------------*/
                  SetReg(CMP_CR2, CMP0SEL0 | CMP0SEL1, 0x00);
                  /*  -------------------------------------------------------------------------------------------------
                      ÊØîËæÉÂô®ËøüÊªûÁîµÂéãÈÄâÊã©
                      000: Êó†ËøüÊªû   001: ¬±2.5mV   010: -5mV   011: +5mV
                      100: +-5mV   101: -10mV   110: +10mV   111: +-10mV
                      -------------------------------------------------------------------------------------------------*
             -/
                  SetReg(CMP_CR1, CMP0HYS0 | CMP0HYS1 | CMP0HYS2, CMP0HYS2  );
                  /*  -------------------------------------------------------------------------------------------------
                      CMP0ÁöÑËΩÆËØ¢Êó∂Èó¥ËÆæÁΩÆ
                      -------------------------------------------------------------------------------------------------*
             -/
                  SetReg(CMP_CR2, CMP0CSEL1 | CMP0CSEL0, 0x00);
                  /*  -------------------------------------------------------------------------------------------------
                      ÊØîËæÉÂô®‰∏≠Êñ≠Ê®°ÂºèÈÖçÁΩÆ
                      00: ‰∏ç‰∫ßÁîü‰∏≠Êñ≠  01: ‰∏äÂçáÊ≤ø‰∫ßÁîü‰∏≠Êñ≠  10: ‰∏ãÈôçÊ≤ø‰∫ßÁîü‰∏≠Êñ≠  11: ‰∏äÂçá/‰∏ãÈôçÊ≤ø‰∫ß
             -Áîü‰∏≠Êñ≠
                      -------------------------------------------------------------------------------------------------*
             -/
                  SetReg(CMP_CR0, CMP2IM0 | CMP2IM1, CMP2IM0 | CMP2IM1);
                  SetReg(CMP_CR0, CMP1IM0 | CMP1IM1, CMP1IM0 | CMP1IM1);
                  SetReg(CMP_CR0, CMP0IM0 | CMP0IM1, CMP0IM0 | CMP0IM1);
                  SetBit(CMP_CR2, CMP0EN);                              //ÂºÄ‰∏â‰∏™ÊØîËæÉÂô®
              }
              
              /** 
               * @brief      BMFÂØπÂ∫îTime2ÁöÑÂàùÂßãÂåñ
               * @date       2022-07-14
               */
              void Time2_BMEF_Init(void)
              {
                  /*  -------------------------------------------------------------------------------------------------
C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 3   

                      ÂÖàÂÅúÊ≠¢ËÆ°Êï∞ÔºåÈÖçÁΩÆÂÆåÂØÑÂ≠òÂô®ÂêéÔºåÊúÄÂêéÂêØÂä®ËÆ°Êï∞
                      -------------------------------------------------------------------------------------------------*
             -/
                  ClrBit(TIM2_CR1, T2EN);                                    // 0ÔºåÂÅúÊ≠¢ËÆ°Êï∞Ôºõ1,‰ΩøËÉΩËÆ°Êï∞
                  /*  -------------------------------------------------------------------------------------------------
                      Êó∂ÈíüÂàÜÈ¢ëËÆæÁΩÆ(T2PSC)
                      000:cpuclk(24MHz)         001:cpuclk/2^1(12MHz)   010:cpuclk/2^2(6MHz)    011:cpuclk/2^3(3MHz)
                      100:cpuclk/2^4(1.5MHz)    101:cpuclk/2^5(750KHz)  110:cpuclk/2^6(375KHz)  111:cpuclk/2^7(187.5KHz)
                      -------------------------------------------------------------------------------------------------*
             -/
                  SetReg(TIM2_CR0, T2PSC0 | T2PSC1 | T2PSC2, T2PSC0 | T2PSC2);
                  /*  -------------------------------------------------------------------------------------------------
                      /Ê®°ÂºèÈÄâÊã©
                      T2MODE1ÔºåT2MODE0
                      00--ËæìÂÖ•TimerÊ®°ÂºèÔºõ01--ËæìÂá∫Ê®°Âºè
                      10--ËæìÂÖ•CountÊ®°ÂºèÔºõ11--QEPÊàñËÄÖRSDÊ®°Âºè
                      -------------------------------------------------------------------------------------------------*
             -/
                  SetReg(TIM2_CR0, T2MOD0 | T2MOD1, T2MOD0);
                  /*  -------------------------------------------------------------------------------------------------
                      Ê∏ÖÈô§‰∏≠Êñ≠Ê†áÂøó‰Ωç
                      Á¶ÅÊ≠¢PWMÂë®ÊúüÊ£ÄÊµã‰∏≠Êñ≠‰ΩøËÉΩ
                      -------------------------------------------------------------------------------------------------*
             -/
                  ClrBit(TIM2_CR0, T2CES);                                       // Ê∏ÖÈõ∂ËÑâÂÜ≤ËÆ°Êï∞Âô®‰∏ç‰ΩøËÉΩ
                  ClrBit(TIM2_CR1, T2IR | T2IF | T2IP);                  // Ê∏ÖÈõ∂‰∏≠Êñ≠Ê†áÂøó‰Ωç
                  /*  -------------------------------------------------------------------------------------------------
                      ÈÖçÁΩÆÂë®ÊúüÂÄº„ÄÅÊØîËæÉÂÄº„ÄÅËÆ°Êï∞ÂÄº
                      Á¶ÅÊ≠¢PWMÂë®ÊúüÊ£ÄÊµã‰∏≠Êñ≠‰ΩøËÉΩ
                      ‰ΩøËÉΩËÆ°Êï∞Âô®‰∏äÊ∫¢‰∏≠Êñ≠‰ΩøËÉΩ
                      -------------------------------------------------------------------------------------------------*
             -/
                  TIM2__ARR = 60000;                                                       // TIM2 Period = 0.32s
                  TIM2__DR = TIM2__ARR;
                  TIM2__CNTR = 0;
                  /*-----------ÂêØÂä®ËÆ°Êï∞------------------------------------------------*/
                  SetBit(TIM2_CR1, T2EN);                                    //ÂêØÂä®ËÆ°Êï∞
              }
              
              /** 
               * @brief      ËØªÂèçÁîµÂä®ÂäøÁä∂ÊÄÅ
               * @date       2022-07-14
               */
              uint8   GetBEMFStatus(void)
              {
                  uint8 BEMFStatus = 0;
                  
                  if (ReadBit(CMP_SR, CMP2OUT))
                  {
                      BEMFStatus += 4;
                  }
                  
                  if (ReadBit(CMP_SR, CMP1OUT))
                  {
                      BEMFStatus += 2;
                  }
                  
                  if (ReadBit(CMP_SR, CMP0OUT))
                  {
                      BEMFStatus += 1;
                  }
                  
C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 4   

                  return BEMFStatus;
              }
              
              /** 
               * @brief      ÂäüËÉΩÂáΩÊï∞ÔºåÊ£ÄÊµãÁîµÊú∫ËΩ¨ÂêëÔºåÊ†πÊçÆÁõ∏ÈÇª‰∏§‰∏™HallÁä∂ÊÄÅÈ°∫Â∫èÊù•Âà§Êñ≠ÁîµÊú∫ËΩ¨Âêë
               * @exception  MC_FR--ÁîµÊú∫ËΩ¨ÂêëÔºåÂèñÂÄº‰∏∫CWÊàñCCW LastHallStatus
               * @date       2022-07-14
               */
              uint8 CWCCWDetect(uint8 HallStatus)
              {
                  static uint8 MC_FR = 0;
                  static uint8 MC_HallStatus = 0;
                  
                  if (MC_HallStatus == 0) //Á¨¨‰∏ÄÊ¨°ËøõÂÖ•‰∏≠Êñ≠
                  {
                      MC_HallStatus = HallStatus;
                      MC_FR = BEMFDetect.FRStatus;
                      return MC_FR;
                  }
                  
                  if (MC_HallStatus != HallStatus)
                  {
                      switch (MC_HallStatus)
                      {
                          case 1:
                              if (HallStatus == 5)
                              {
                                  MC_FR = CCW;
                              }
                              
                              if (HallStatus == 3)
                              {
                                  MC_FR = CW;
                              }
                              
                              break;
                              
                          case 2:
                              if (HallStatus == 3)
                              {
                                  MC_FR = CCW;
                              }
                              
                              if (HallStatus == 6)
                              {
                                  MC_FR = CW;
                              }
                              
                              break;
                              
                          case 3:
                              if (HallStatus == 1)
                              {
                                  MC_FR = CCW;
                              }
                              
                              if (HallStatus == 2)
                              {
                                  MC_FR = CW;
                              }
                              
                              break;
C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 5   

                              
                          case 4:
                              if (HallStatus == 6)
                              {
                                  MC_FR = CCW;
                              }
                              
                              if (HallStatus == 5)
                              {
                                  MC_FR = CW;
                              }
                              
                              break;
                              
                          case 5:
                              if (HallStatus == 4)
                              {
                                  MC_FR = CCW;
                              }
                              
                              if (HallStatus == 1)
                              {
                                  MC_FR = CW;
                              }
                              
                              break;
                              
                          case 6:
                              if (HallStatus == 2)
                              {
                                  MC_FR = CCW;
                              }
                              
                              if (HallStatus == 4)
                              {
                                  MC_FR = CW;
                              }
                              
                              break;
                              
                          default:
                              break;
                      }
                      
                      MC_HallStatus = HallStatus;
                  }
                  
                  return MC_FR;
              }
              
              
              /** 
               * @brief      Ê£ÄÊµãÈÄüÂ∫¶ÁöÑËÆ°Êó∂
               * @date       2022-07-14
               */
              void BEMFSpeedDetect(void)
              {
                  if (BEMFDetect.BEMFSpeedInitStatus == 0)
                  {
                      BEMFDetect.BEMFSpeedInitStatus = 1;
                      BEMFDetect.PeriodTime = 0;
                      BEMFDetect.MC_StepTime[0] = 0;
C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 6   

                      BEMFDetect.MC_StepTime[1] = 0;
                      BEMFDetect.MC_StepTime[2] = 0;
                      BEMFDetect.MC_StepTime[3] = 0;
                      BEMFDetect.MC_StepTime[4] = 0;
                      BEMFDetect.MC_StepTime[5] = 0;
                      BEMFDetect.BEMFStep = 0;
                      BEMFDetect.StepTime = 0;
                      BEMFDetect.FirstCycle = 0;
                  }
                  else
                  {
                      BEMFDetect.StepTime = TIM2__CNTR;
                      TIM2__CNTR = 0;
                      BEMFDetect.MC_StepTime[BEMFDetect.BEMFStep] = BEMFDetect.StepTime;
                      BEMFDetect.PeriodTime = (BEMFDetect.MC_StepTime[0] + BEMFDetect.MC_StepTime[1] + BEMFDetect.MC_Ste
             -pTime[2] +
                              BEMFDetect.MC_StepTime[3] + BEMFDetect.MC_StepTime[4] + BEMFDetect.MC_StepTime[5]) >> 3;
                      BEMFDetect.BEMFStep++;
                      
                      if (BEMFDetect.FirstCycle) //360Â∫¶ÔºåÁ¨¨‰∏ÄÂúàÊòØ360ËÆ°ÁÆó‰∏ÄÊ¨°ÈÄüÂ∫¶ÔºåÁ¨¨‰∫åÂúàÊòØ60Â∫¶ËÆ°ÁÆó‰
             -∏ÄÊ¨°ÈÄüÂ∫¶
                      {
                          BEMFDetect.FlagSpeedCal = 1;
                          BEMFDetect.BEMFSpeedBase = TempBEMFSpeedBase;
                      }
                      else//60Â∫¶
                      {
                          BEMFDetect.FlagSpeedCal = 1;
                          BEMFDetect.BEMFSpeedBase = TempBEMFSpeedBase1;
                          BEMFDetect.PeriodTime = BEMFDetect.StepTime;
                      }
                      
                      if (BEMFDetect.BEMFStep == 6)
                      {
                          BEMFDetect.FirstCycle = 1;
                          BEMFDetect.BEMFStep = 0;
                      }
                  }
              }
              
              /** 
               * @brief      ÈÄüÂ∫¶ËÆ°ÁÆóÔºåÂæóÂà∞ÁöÑÊòØQÊ†ºÂºèÁöÑÊï∞
               * @date       2022-07-14
               */
              void BEMFSpeedCal(void)
              {
                  if (BEMFDetect.FlagSpeedCal) //Ê≠§Â§ÑÊ≥®ÊÑèXDATAÂíåÈô§Êï∞Âè™ËÉΩÊòØ16‰ΩçÁöÑÈóÆÈ¢ò
                  {
                      BEMFDetect.BEMFSpeed    = DivQ_L_MDU(BEMFDetect.BEMFSpeedBase >>16, BEMFDetect.BEMFSpeedBase, BEMF
             -Detect.PeriodTime);
                      //ÂæóÂà∞ÁöÑÊòØQÊ†ºÂºèÁöÑÈÄüÂ∫¶,Ê≠§Â§ÑÈô§Ê≥ïÂô®‰∏éËøáË∞ÉÂÄº‰∏çÂÜ≤Á™Å
                      BEMFDetect.FlagSpeedCal = 0;
                  }
              }
              
              
              /** 
               * @brief      BEMFÊ£ÄÊµãÔºåÂà§Êñ≠ÊñπÂêëÔºåÈÄüÂ∫¶Ôºå‰ª•ÂèäÈ°∫È£éÂàáÈó≠ÁéØ
               * @date       2022-07-14
               */
              void BEMFDetectFunc(void)
              {
C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 7   

                  if (ReadBit(CMP_SR, CMP0IF) || ReadBit(CMP_SR, CMP1IF) || ReadBit(CMP_SR, CMP2IF)) //ÂΩìÊ£ÄÊµãÂà∞ÊØîËæ
             -ÉÂô®‰∏≠Êñ≠Êó∂
                  {
                      //Ê£ÄÊµãÂΩìÂâçBEMFÁä∂ÊÄÅ
                      BEMFDetect.BEMFStatus = GetBEMFStatus();
                      //Ê†πÊçÆBEMFÁä∂ÊÄÅÂà§Êñ≠FRÁä∂ÊÄÅ
                      BEMFDetect.FRStatus = CWCCWDetect(BEMFDetect.BEMFStatus);
                      //ÈÄüÂ∫¶Ê£ÄÊµã
                      BEMFSpeedDetect();
                      //ÈÄüÂ∫¶ËÆ°ÁÆó
                      BEMFSpeedCal();
                      
                      //Âº∫Âà∂ÂêØÂä®Ê†áÂøó‰ΩøËÉΩÊó∂
                      if (BEMFDetect.BEMFStartStatus)
                      {
                          //CWÊó∂UÁõ∏BEMF‰∏äÂçáÊ≤øÂêØÂä®ÔºåCCWÊó∂VÁõ∏BEMF‰∏äÂçáÊ≤øÂêØÂä®
                          if (((MCCtrl.FR_Status == CW) && (BEMFDetect.BEMFStatus == 5)) || ((MCCtrl.FR_Status == CCW) &
             -& (BEMFDetect.BEMFStatus == 3)))
                          {
                              //ÊâßË°åÁõ¥Êé•Èó≠ÁéØÂêØÂä®Á®ãÂ∫è
                              BEMFFOCCloseLoopStart();
                              ClrBit(CMP_CR0, CMP2IM1 | CMP2IM0 | CMP1IM1 | CMP1IM0 | CMP0IM1 | CMP0IM0);
                              ClrBit(CMP_CR2, CMP0EN);
                              BEMFDetect.BEMFStartStatus = 0;
                          }
                      }
                      
                      ClrBit(CMP_SR, CMP0IF | CMP1IF | CMP2IF);           //Ê∏ÖÈô§‰∏≠Êñ≠Ê†áÂøó‰Ωç 
                  }
              }
              
              /** 
               * @brief      BEMFÂ§ÑÁêÜÊñπÂºè
               * @date       2022-07-14
               */
              void BEMFDealwith(void)
              {
                  if ((BEMFDetect.BEMFTimeCount < (BEMF_START_DETECT_TIME - BEMF_START_DELAY_TIME)))
                  {
                      if (BEMFDetect.FRStatus == MCCtrl.FR_Status)
                      {
                          //Ë∂ÖËøáËÆæÂÆöËΩ¨ÈÄüÊó∂Áõ¥Êé•ÂêØÂä®
                          if ((BEMFDetect.BEMFSpeed > BEMFMotorStartSpeed) && (BEMFDetect.BEMFSpeed < BEMFMotorStartSpee
             -dHigh))
                          {
                              BEMFDetect.BEMFStartStatus = 1;
                          }
                      }
                      else//ÂèçËΩ¨ÔºåÂàπËΩ¶
                      {
                          McStaSet.SetFlag.TailWindSetFlag = 0;
                          MOE = 0;
                          DRV_DR = DRV_ARR + 1;
                          DRV_CMR &= 0xFFC0;
                          DRV_CMR |= 0x015;                         // ‰∏âÁõ∏‰∏ãÊ°•ËáÇÈÄöÔºåÂàπËΩ¶
                          ClrBit(DRV_CR, OCS); //OCS = 0, DRV_COMR;OCS = 1, FOC/SVPWM/SPWM
                          //            SetBit(DRV_CR, DRVEN);
                          MOE = 1;
                          ClrBit(CMP_CR0, CMP2IM1 | CMP2IM0 | CMP1IM1 | CMP1IM0 | CMP0IM1 | CMP0IM0);
                          ClrBit(CMP_CR2, CMP0EN);
                          
                          if (BEMFDetect.BEMFSpeed > _Q15(300.0 / MOTOR_SPEED_BASE))
C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 8   

                          {
                              mcFocCtrl.State_Count = 200;
                              BEMFDetect.BEMFCCWFlag = 1;
                          }
                          else
                          {
                              mcFocCtrl.State_Count = 100;
                              
                              if (BEMFDetect.BEMFCCWFlag == 0)
                              { BEMFDetect.BEMFCCWFlag = 2; }
                          }
                      }
                  }
                  
                  if (BEMFDetect.BEMFTimeCount == 0)// && (BEMFDetect.BEMFSpeed <= BEMFMotorStartSpeed)) //ÈùôÊ≠¢Êàñ‰ΩéÈ
             -Äü
                  {
                      ClrBit(CMP_CR0, CMP2IM1 | CMP2IM0 | CMP1IM1 | CMP1IM0 | CMP0IM1 | CMP0IM0);
                      ClrBit(CMP_CR2, CMP0EN);
                      mcState = mcPosiCheck;
                      McStaSet.SetFlag.PosiCheckSetFlag = 0;
                      mcFocCtrl.mcPosCheckAngle           = 0xffff;         // ËßíÂ∫¶ËµãÂàùÂÄº
                  }
              }
              
              
              /** 
               * @brief      ÂØπFOCÁöÑÁõ∏ÂÖ≥ÂØÑÂ≠òÂô®ËøõË°åÈÖçÁΩÆ,ÂÖàÊ∏ÖÁêÜÂØÑÂ≠òÂô®ÔºåÂêéÈÖçÁΩÆÔºåÊúÄÂêé‰ΩøËÉΩ
               * @exception  Èó≠ÁéØÂêØÂä®
               * @date       2022-07-14
               */
              void BEMFFOCCloseLoopStart(void)
              {
                  /*FOCÂàùÂßãÂåñ*/
                  FOC_Init();
                  /*ÂêØÂä®ÁîµÊµÅ„ÄÅKP„ÄÅKI*/
                  FOC_IDREF = ID_Start_CURRENT;                         // DËΩ¥ÂêØÂä®ÁîµÊµÅ
                  mcFocCtrl.mcIqref = IQ_RUN_CURRENT;                     // QËΩ¥ÂêØÂä®ÁîµÊµÅ
                  FOC_IQREF = mcFocCtrl.mcIqref;                          // QËΩ¥ÂêØÂä®ÁîµÊµÅ
                  FOC_DQKP = DQKP;
                  FOC_DQKI = DQKI;
                  FOC_EFREQACC    = Motor_Omega_Ramp_ACC;
                  FOC_EFREQMIN    = Motor_Omega_Ramp_Min;
                  FOC_EFREQHOLD = Motor_Omega_Ramp_End;
                  SetBit(FOC_CR1, EFAE);                                                          // ‰º∞ÁÆóÂô®Âº∫Âà∂ËæìÂ
             -á∫
                  ClrBit(FOC_CR1, RFAE);                                                          // Á¶ÅÊ≠¢Âº∫Êãâ
                  SetBit(FOC_CR1, ANGM);                                                          // ‰º∞ÁÆóÊ®°Âºè
                  FOC__EOME = BEMFDetect.BEMFSpeed;
                  
                  #if (EstimateAlgorithm == PLL)
                  {
                      FOC_EKP                           = OBSW_KP_GAIN_RUN2;
                      FOC_EKI                           = OBSW_KI_GAIN_RUN2;
                      mcFocCtrl.mcIqref                 = IQ_RUN_CURRENT;
                  }
                #else
                  {
                      //Ê†πÊçÆ‰∏çÂêåËΩ¨ÈÄüÁ°ÆÂêØÂä®ÁöÑATO_BWÂÄº
                      FOC_EKP                       = OBSW_KP_GAIN_RUN2;
                      FOC_EKI                       = OBSW_KI_GAIN_RUN2;
                      mcFocCtrl.mcIqref             = IQ_RUN_CURRENT;
C51 COMPILER V9.60.7.0   BEMFDETECT                                                        08/30/2023 13:47:06 PAGE 9   

                      mcFocCtrl.State_Count         = 10;
                  }
                  #endif //end    EstimateAlgorithm
                  FOC_OMEKLPF                           = SPEED_KLPF;
                  mcState                               = mcRun;
                  mcFocCtrl.CtrlMode                    = 0;
                  /*‰ΩøËÉΩËæìÂá∫*/
                  DRV_CMR |= 0x3F;                         // U„ÄÅV„ÄÅWÁõ∏ËæìÂá∫
                  MOE = 1;
                  EA = 1;
              }
              #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
